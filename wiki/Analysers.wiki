#summary The concept of analysers, categories of analysers, and how to add an analyser to AARAE.
#sidebar TableOfContents

<wiki:toc max_depth="3" />


= Introduction =

An analyser in AARAE primarily aims to provide user-readable output, for example in the form of a visualisation together with numeric data. An analyser can also provide auralization or sonification, but some such cases may be better as a _processor_ rather than an _analyser_ (if the audio content of the auralization/sonification is the main purpose of the function - see [Processors]).

Usually it is quite easy to adapt a pre-existing (or newly written) Matlab function so that it can be integrated into AARAE as an analyser. This page provides information on how this can be done, and there are also many analysers already in AARAE that can serve as examples.

= Overview of Analysers in AARAE =

The collection of analysers in AARAE is organised into directories each for a general category of analyser. From time to time these directories may change or be added to.

== Binaural ==

This category of analyser is concerned with the analysis of binaural impulse responses or signals. This can include examining head-related transfer function, deriving binaural room acoustical parameters, and so on. There may be some binaural analysers that are not in this folder (e.g., a binaural speech intelligibility model is more likely to be in the _Speech_ directory).

== Energy Ratios ==

Energy ratios are used in several ways in room acoustics, and this category of analyser is concerned with parameters such as clarity index, definition, centre time, stage support, voice support, direct-to-reverberant ratio, etc.

== Reverberation ==

This category of analyser is primarily concerned with the calculation of reverberation time, early decay time, and related parameters.

== Spatial Analysis ==

== Speech ==

This category of analyser is concerned with aspects of speech, including speech intelligibility and speech level. It contains analysers that follow IEC and ANSI standards for estimating speech intelligibility from acoustic response data.

 * SII_IR: an analyser that derives the speech intelligibility index from an impulse response, and signal and noise level data, using the modulation transfer function of the impulse response.

 * STI_from_speech: an experimental analyser, which derives an approximate modulation transfer function from a 2-channel speech recording (where one channel is 'dry', and the other is affected by reverberation and noise). STI is derived in the normal manner from the modulation transfer function.

 * STI_IR: an analyser that derives the speech transmission index from an impulse response, and signal and noise level data, using the modulation transfer function of the impulse response.

 * STIPA_direct: an analyser to derive STIPA from a recording of the STIPA signal (which can be generated using the STIPA_signal AARAE generator).

 * STIspeechlevel: an analyser to calculate the speech level, as described by Annex J of IEC 602268-16 (2011), to support the calculation of the speech transmission index. 

== Statistics ==

== Strength ==

== Temporal Diffusivity ==

== Visualisation ==

= Adding an Analyser to AARAE=

== Name and Description ==
The name of the function is what a user sees within the GUI, so contributed functions need to have helpful names. In some cases, there may be several analyser functions that do similar things (e.g. different ways of estimating reverberation time from an impulse response), and so the function name should be specific enough to accommodate the alternative functions. In other words, it is not a good idea to call a function 'reverbtime', but instead the name should have more particular information (such as the algorithm used, etc).

Within the GUI, hovering the mouse over the name of the function will bring up a description of the function (if one has been written). This description is the continuous comments within the function immediately following the function declaration. Please consider what text should be included there - such as a brief statement of what the function does, a reference to a publication (if relevant), and some guidance on how to use the analyser. It is a good idea to include the author, version and date in this text.


== Analyser Inputs ==

The inputs to an analyser are likely to include audio data, metadata (e.g. sampling rate), and user-controlled settings for the analyser.

=== Audio Data and Metadata ===

Audio data and metadata in AARAE are kept within a structure. *An analyser for AARAE should have this structure as its first input argument.*

The currently available fields within this structure include:

|| *Field* || * Description and comment* ||
|| .audio || This contains the audio waveform, varying in time down the columns. Dimension 2 is used for channels, and dimension 3 is used for bands (e.g. octave-band filtered data). Analysers should be written to anticipate a potentially 3-dimensional waveform matrix, rather than returning an error if the input is multi-channel and/or multi-band. ||
|| .invaudio || This is a complementary audio waveform, such as an inverse filter used to transform a recorded sweep into an impulse response. Some AARAE generators (but not all) create this field, and it might not be present in the audio structure at the analyser stage. ||
|| .fs || This is the audio sampling rate in Hz. ||
|| .nbits || This is the bit depth of the audio when playing, recording or writing audio to a wave file. ||
|| .bandID || This is a list of frequencies (or numbers of some type) associated with each band. ||
|| .chanID || This is a list of channel identifiers (e.g. angles in the case of beam-formed audio) - which has not been implemented yet. ||
|| .cal || This is a calibration offset in decibels such that 10*log10(wave.^2)+cal yields the appropriate level (e.g., sound pressure level). ||
|| .signaltype || This is a string describing the type of signal. ||

It is best practice to write an analyser function to accept structure input, as well accepting as a set of discrete input arguments (which can be more convenient if the function is not being called via the GUI, for example if it is doing a large scale scripted analysis during which dialog boxes would be a nuisance). This can be achieved using an isstruct() test, for example:

<code language="m">
function dosomething(in, fs, cal)
if isstruct(in)
       audio = in.audio; % audio wave data
       fs = in.fs; % audio sampling rate in Hz
      cal = in.cal; % calibration offset in dB
else
       audio = in;
end
% then do something with the data and metadata ...
</code>

In the above example, the second and third input arguments are ignored if the first input argument is a structure. However if the first input argument is a vector or matrix, it will be used directly as the audio waveform, and the second and third input arguments are required (notwithstanding further code to set default values).

Considering that the audio waveform might be 1, 2 or 3-dimensional, it may be important to be able to read its size. The following code provides this information:

<code language="m">
S = size(audio); % size of the audio matrix
ndim = length(S); % number of dimensions
switch ndim
    case 2
        len = S(1); % number of samples in audio
        chans = S(2); % number of channels
        bands = 1; % number of bands
    case 3
        len = S(1); % number of samples in audio
        chans = S(2); % number of channels
        bands = S(3); % number of bands
end
</code>

(Note that the Matlab function size() returns two values if there is only one dimension.)

Having obtained this information, we then need to decide what to do with it. Some analysers will work perfectly well on any number of channels and bands, while others may be designed only for 1 channel, 2 channels, 1 band, or some other constraints. One option is to return an error if the input is incorrectly dimensioned. Another option is to truncate and/or mix the data as required. For example:

<code language="m">
if bands > 1
      audio = mean(audio,3); % mix all bands together (removing the third dimension)
      disp('Multiband audio has been mixed into a single band.')
end
</code>

or

<code language="m">
if chans > 2
       audio = audio(:,1:2,:); % use only the first two channels
       disp('Only the first two channels have been used.')
end
</code>

Sometimes a field that would be used by the analyser is not present in the input structure. For example, the calibration offset might not be present if the data has not been calibrated. The following example shows how this can be dealt with.

<code language="m">
if exist(in.cal, 'var')
      cal = in.cal; % get the calibration offset from the input structure
else
      cal = 0; % set to default value (but it would be more useful to get a value via a dialog box)
end
</code>

=== Function Settings ===

When running an analyser from the AARAE GUI, the user-controlled settings for an analyser need to be entered using a dialog box. Fortunately it is quite easy to add a rudimentary dialog box to a Matlab function, which is often all that is required. Matlab's inputdlg() is one way of achieving this (refer to Matlab's help). The following is an example of a dialog box with three user-set parameters:

<code language="m">
% Dialog box for settings

% Prompt for 3 named parameters:
    prompt = {'Threshold for IR start detection (dB)', ...
        'Bands per octave (1 | 3)', ...
        'Plot (0 | 1)'};

% Title of the dialog box
    dlg_title = 'Settings'; 

    num_lines = 1;

% Default values
    def = {'-20','1','1'}; 

    answer = inputdlg(prompt,dlg_title,num_lines,def);
    
% Set function variables from dialog box user-input values
    if ~isempty(answer)
        startthresh = str2num(answer{1,1});
        bpo = str2num(answer{2,1});
        doplot = str2num(answer{3,1});
    end
</code>



== Charts and Other Outputs ==

It is worth thinking about how the result of running the analyser can be best represented. Charts are usually helpful, and other options include numerical tables, sonification, etc.

Sometimes a while loop could make it easier to work with multiple output options (so the user can choose whether or not to generate each output type, and indeed to discard the analysis results).

=== Format of Data Returned by the Analyser Function ===

This issue is still under development.

== License ==

AARAE uses the BSD 3-Clause license for the project as a whole, and therefore  contributed code within the project should also use it to avoid license conflicts.

Except, perhaps, in the case of minor contributions, please add the following license to your Matlab function as a comment. Change the YEAR, OWNER and ORGANISATION fields as appropriate. The license comment could be at the end of the m file.

<code language="m">
% Copyright (c) YEAR, OWNER
% All rights reserved.
%
% Redistribution and use in source and binary forms, with or without 
% modification, are permitted provided that the following conditions are 
% met:
%
%  * Redistributions of source code must retain the above copyright notice,
%    this list of conditions and the following disclaimer.
%  * Redistributions in binary form must reproduce the above copyright 
%    notice, this list of conditions and the following disclaimer in the 
%    documentation and/or other materials provided with the distribution.
%  * Neither the name of the ORGANISATION nor the names of its contributors
%    may be used to endorse or promote products derived from this software 
%    without specific prior written permission.
%
% THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 
% "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
% TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A 
% PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER
% OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
% EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
% PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
% PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
% LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING 
% NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
% SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</code>

== Incorporating the Analyser into AARAE ==

Once a function has been appropriately prepared, it can be integrated into AARAE simply by putting it into the appropriate subdirectory within the Analysers directory in the AARAE file structure. If required, a new subdirectory can be added (but please avoid unnecessarily adding subdirectories).

Make sure that the analyser works as intended (both as as a stand-alone function, and via the AARAE GUI). If you are hoping that other people will find the analyser helpful, make sure that it is adequately documented (at least by comments within the m file).

If you are a contributor to this Google Code group, you can add it to the repository via Subversion (svn). Otherwise contact Densil Cabrera directly.